% for ploting probability density of spikes
%
% INPUTS
%
% A         : spikes time courses (time in second dimension)
% 
% OPTIONAL
% times     : vector with times for spikes ([])
% winP      : length of Gaussian window in percentage of range (1)
% doploting : if ==1 plots spike PDF
% bins      : number of bins for amplitude - pic resolution(1000) 
% 
%
%
% OUTPUTS
%
% D         : matrix with spike pdf to plot using imagesc
% AMPs      : vector with amplitudes 

function [D,AMPs]=spikePDFestimate(A,times,winP,doploting,bins)

plotcolorbar=0; % if 1 adding colorbar to plot

if nargin==1
    winP=4;
    doploting=1 ;
    bins=1000;
    times=[];
elseif nargin==2
    winP=4;
    doploting=1;
    bins=1000;
elseif nargin==3
    doploting=1;
    bins=1000;
elseif nargin==4
    bins=2000;
end

margins=round(bins.*0.10);%10% margins;
win=bins.*winP./100;

added=min(A(:));
A=A-added;
res=(max(A(:))./bins);


A=round(A./res)+margins;
range=max(A(:))+margins;

AMPs=((1:range)-margins).*(res)+added;

%%
for t=1:size(A,2)
    clear C
    C(range,size(A,1))=0;
    %[I,J] = ind2sub([size(A)],1:length(A(:)));
    %K=sub2ind(size(C),A(:),J(:),I(:));
    K=sub2ind(size(C),A(:,t)',1:size(A,1));
    C(K)=1;
    C=mean(C,2);
    %%
    
    D(:,t) = conv(C, gausswin(win)/sum(gausswin(win)),'same');
end
%%


if doploting==1
    
    imagesc(times,AMPs,D);
    
    set(gcf,'Colormap',...
        [1 1 1;0.967741906642914 0.967741906642914 1;0.935483872890472 0.935483872890472 1;0.903225779533386 0.903225779533386 1;0.870967745780945 0.870967745780945 1;0.838709652423859 0.838709652423859 1;0.806451618671417 0.806451618671417 1;0.774193525314331 0.774193525314331 1;0.74193549156189 0.74193549156189 1;0.709677398204803 0.709677398204803 1;0.677419364452362 0.677419364452362 1;0.645161271095276 0.645161271095276 1;0.612903237342834 0.612903237342834 1;0.580645143985748 0.580645143985748 1;0.548387110233307 0.548387110233307 1;0.516129016876221 0.516129016876221 1;0.483870953321457 0.483870953321457 1;0.451612889766693 0.451612889766693 1;0.419354826211929 0.419354826211929 1;0.387096762657166 0.387096762657166 1;0.354838699102402 0.354838699102402 1;0.322580635547638 0.322580635547638 1;0.290322571992874 0.290322571992874 1;0.25806450843811 0.25806450843811 1;0.225806444883347 0.225806444883347 1;0.193548381328583 0.193548381328583 1;0.161290317773819 0.161290317773819 1;0.129032254219055 0.129032254219055 1;0.0967741906642914 0.0967741906642914 1;0.0645161271095276 0.0645161271095276 1;0.0322580635547638 0.0322580635547638 1;0 0 1;0 0.015625 1;0 0.03125 1;0 0.046875 1;0 0.0625 1;0 0.078125 1;0 0.09375 1;0 0.109375 1;0 0.125 1;0 0.140625 1;0 0.15625 1;0 0.171875 1;0 0.1875 1;0 0.203125 1;0 0.21875 1;0 0.234375 1;0 0.25 1;0 0.265625 1;0 0.28125 1;0 0.296875 1;0 0.3125 1;0 0.328125 1;0 0.34375 1;0 0.359375 1;0 0.375 1;0 0.390625 1;0 0.40625 1;0 0.421875 1;0 0.4375 1;0 0.453125 1;0 0.46875 1;0 0.484375 1;0 0.5 1;0 0.515625 1;0 0.53125 1;0 0.546875 1;0 0.5625 1;0 0.578125 1;0 0.59375 1;0 0.609375 1;0 0.625 1;0 0.640625 1;0 0.65625 1;0 0.671875 1;0 0.6875 1;0 0.703125 1;0 0.71875 1;0 0.734375 1;0 0.75 1;0 0.765625 1;0 0.78125 1;0 0.796875 1;0 0.8125 1;0 0.828125 1;0 0.84375 1;0 0.859375 1;0 0.875 1;0 0.890625 1;0 0.90625 1;0 0.921875 1;0 0.9375 1;0 0.953125 1;0 0.96875 1;0 0.984375 1;0 1 1;0.015625 1 0.984375;0.03125 1 0.96875;0.046875 1 0.953125;0.0625 1 0.9375;0.078125 1 0.921875;0.09375 1 0.90625;0.109375 1 0.890625;0.125 1 0.875;0.140625 1 0.859375;0.15625 1 0.84375;0.171875 1 0.828125;0.1875 1 0.8125;0.203125 1 0.796875;0.21875 1 0.78125;0.234375 1 0.765625;0.25 1 0.75;0.265625 1 0.734375;0.28125 1 0.71875;0.296875 1 0.703125;0.3125 1 0.6875;0.328125 1 0.671875;0.34375 1 0.65625;0.359375 1 0.640625;0.375 1 0.625;0.390625 1 0.609375;0.40625 1 0.59375;0.421875 1 0.578125;0.4375 1 0.5625;0.453125 1 0.546875;0.46875 1 0.53125;0.484375 1 0.515625;0.5 1 0.5;0.515625 1 0.484375;0.53125 1 0.46875;0.546875 1 0.453125;0.5625 1 0.4375;0.578125 1 0.421875;0.59375 1 0.40625;0.609375 1 0.390625;0.625 1 0.375;0.640625 1 0.359375;0.65625 1 0.34375;0.671875 1 0.328125;0.6875 1 0.3125;0.703125 1 0.296875;0.71875 1 0.28125;0.734375 1 0.265625;0.75 1 0.25;0.765625 1 0.234375;0.78125 1 0.21875;0.796875 1 0.203125;0.8125 1 0.1875;0.828125 1 0.171875;0.84375 1 0.15625;0.859375 1 0.140625;0.875 1 0.125;0.890625 1 0.109375;0.90625 1 0.09375;0.921875 1 0.078125;0.9375 1 0.0625;0.953125 1 0.046875;0.96875 1 0.03125;0.984375 1 0.015625;1 1 0;1 0.984375 0;1 0.96875 0;1 0.953125 0;1 0.9375 0;1 0.921875 0;1 0.90625 0;1 0.890625 0;1 0.875 0;1 0.859375 0;1 0.84375 0;1 0.828125 0;1 0.8125 0;1 0.796875 0;1 0.78125 0;1 0.765625 0;1 0.75 0;1 0.734375 0;1 0.71875 0;1 0.703125 0;1 0.6875 0;1 0.671875 0;1 0.65625 0;1 0.640625 0;1 0.625 0;1 0.609375 0;1 0.59375 0;1 0.578125 0;1 0.5625 0;1 0.546875 0;1 0.53125 0;1 0.515625 0;1 0.5 0;1 0.484375 0;1 0.46875 0;1 0.453125 0;1 0.4375 0;1 0.421875 0;1 0.40625 0;1 0.390625 0;1 0.375 0;1 0.359375 0;1 0.34375 0;1 0.328125 0;1 0.3125 0;1 0.296875 0;1 0.28125 0;1 0.265625 0;1 0.25 0;1 0.234375 0;1 0.21875 0;1 0.203125 0;1 0.1875 0;1 0.171875 0;1 0.15625 0;1 0.140625 0;1 0.125 0;1 0.109375 0;1 0.09375 0;1 0.078125 0;1 0.0625 0;1 0.046875 0;1 0.03125 0;1 0.015625 0;1 0 0;0.984375 0 0;0.96875 0 0;0.953125 0 0;0.9375 0 0;0.921875 0 0;0.90625 0 0;0.890625 0 0;0.875 0 0;0.859375 0 0;0.84375 0 0;0.828125 0 0;0.8125 0 0;0.796875 0 0;0.78125 0 0;0.765625 0 0;0.75 0 0;0.734375 0 0;0.71875 0 0;0.703125 0 0;0.6875 0 0;0.671875 0 0;0.65625 0 0;0.640625 0 0;0.625 0 0;0.609375 0 0;0.59375 0 0;0.578125 0 0;0.5625 0 0;0.546875 0 0;0.53125 0 0;0.515625 0 0;0.5 0 0]);
    
    if plotcolorbar==1
        
        h=colorbar;
        set(get(h,'ylabel'),'String','probability density')
    end
    axis xy
end

